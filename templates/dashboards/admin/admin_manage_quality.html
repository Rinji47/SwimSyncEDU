{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Pool Quality - SwimSync EDU{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/admin_manage.css' %}">
{% endblock %}

{% block extra_js %}
<script>
function toggleModal(id) {
    document.getElementById(id).classList.toggle('show');
}

function resetModalFields(modal) {
    modal.querySelector("form").reset();
}

// Open Add modal
function openAddQualityModal() {
    const modal = document.getElementById("qualityModal");
    const form = modal.querySelector("form");

    resetModalFields(modal);

    form.action = "{% url 'add_quality' %}";
    modal.querySelector("h2").textContent = "Add Quality Record";

    toggleModal("qualityModal");
}

// Open Edit modal
function openEditQualityModal(btn) {
    const modal = document.getElementById("qualityModal");
    const form = modal.querySelector("form");
    const quality = JSON.parse(btn.dataset.quality);

    // Set form action dynamically to edit URL
    form.action = btn.dataset.url;

    // Fill in the fields
    modal.querySelector("#quality_pool_id").value = quality.pool_id;
    modal.querySelector("#quality_date").value = quality.date;
    modal.querySelector("#cleanliness_rating").value = quality.cleanliness_rating;
    modal.querySelector("#pH_level").value = quality.pH_level || "";
    modal.querySelector("#water_temperature").value = quality.water_temperature || "";
    modal.querySelector("#chlorine_level").value = quality.chlorine_level || "";

    modal.querySelector("h2").textContent = "Edit Quality Record";

    toggleModal("qualityModal");
}

function openQualityViewModal(btn) {
    const modal = document.getElementById("qualityViewModal");
    const quality = JSON.parse(btn.dataset.quality);

    modal.querySelector("#quality_view_pool").textContent = quality.pool_name || "";
    modal.querySelector("#quality_view_date").textContent = quality.date || "";
    modal.querySelector("#quality_view_rating").textContent = quality.cleanliness_rating || "";
    modal.querySelector("#quality_view_ph").textContent = quality.pH_level || "N/A";
    modal.querySelector("#quality_view_temp").textContent = quality.water_temperature ? `${quality.water_temperature}°C` : "N/A";
    modal.querySelector("#quality_view_chlorine").textContent = quality.chlorine_level ? `${quality.chlorine_level} ppm` : "N/A";

    toggleModal("qualityViewModal");
}
</script>
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    {% include "./components/admin_sidebar.html" %}

    <main class="dashboard-main">
        {% include "../../components/message.html" %}

        <div class="dashboard-header">
            <h1>Manage Pool Quality</h1>
            <button class="btn-primary" onclick="openAddQualityModal()">Add Quality Record</button>
        </div>

        <!-- Filter Section -->
        <form class="filter-bar" method="GET">
            <div class="filter-main">
                <div class="filter-search">
                    <input type="text" class="filter-input" name="q" placeholder="Search quality..." value="{{ request.GET.q|default_if_none:'' }}">
                    <button type="submit" class="btn-secondary">Search</button>
                    <button type="button" class="btn-secondary filter-toggle" aria-expanded="false" aria-controls="filters-quality">Filters v</button>
                </div>
            </div>
            <div class="filter-advanced" id="filters-quality">
                <div class="filter-field">
                    <label for="pool_filter">Pool</label>
                    <select name="pool" id="pool_filter" class="filter-select">
                        <option value="">All Pools</option>
                        {% for pool in pools %}
                        <option value="{{ pool.pool_id }}" {% if request.GET.pool == pool.pool_id|stringformat:"i" %}selected{% endif %}>{{ pool.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-field">
                    <label for="rating_filter">Rating</label>
                    <select name="rating" id="rating_filter" class="filter-select">
                        <option value="">Any</option>
                        <option value="5" {% if request.GET.rating == '5' %}selected{% endif %}>5</option>
                        <option value="4" {% if request.GET.rating == '4' %}selected{% endif %}>4</option>
                        <option value="3" {% if request.GET.rating == '3' %}selected{% endif %}>3</option>
                        <option value="2" {% if request.GET.rating == '2' %}selected{% endif %}>2</option>
                        <option value="1" {% if request.GET.rating == '1' %}selected{% endif %}>1</option>
                    </select>
                </div>
            </div>
        </form>

        <!-- Quality Records Cards -->
        <div class="dashboard-section">
            <div class="data-card-grid">
                {% for quality in qualities %}
                <div class="data-card">
                    <span class="data-card-status">
                        {% if quality.cleanliness_rating >= 4 %}
                            Excellent
                        {% elif quality.cleanliness_rating >= 3 %}
                            Good
                        {% else %}
                            Needs Attention
                        {% endif %}
                    </span>
                    <h3 class="data-card-title">{{ quality.pool.name }}</h3>
                    <div class="data-card-row">
                        <span class="data-card-label">Date:</span>
                        <span>{{ quality.date|date:"M d, Y" }}</span>
                    </div>
                    <div class="data-card-row">
                        <span class="data-card-label">Rating:</span>
                        <span>
                            <span class="rating-stars">
                                {% for i in "12345" %}
                                    {% if forloop.counter <= quality.cleanliness_rating %}
                                        <span style="color: #fbbf24;">★</span>
                                    {% else %}
                                        <span style="color: #e5e7eb;">★</span>
                                    {% endif %}
                                {% endfor %}
                            </span>
                            ({{ quality.cleanliness_rating }}/5)
                        </span>
                    </div>
                    <div class="data-card-row">
                        <span class="data-card-label">pH:</span>
                        <span>
                            {% if quality.pH_level %}
                                <span class="{% if quality.pH_level >= 7.2 and quality.pH_level <= 7.8 %}status-open{% else %}status-closed{% endif %}">
                                    {{ quality.pH_level }}
                                </span>
                            {% else %}
                                <span style="color: var(--text-secondary);">N/A</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="data-card-row">
                        <span class="data-card-label">Temp:</span>
                        <span>
                            {% if quality.water_temperature %}
                                {{ quality.water_temperature }}°C
                            {% else %}
                                <span style="color: var(--text-secondary);">N/A</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="data-card-row">
                        <span class="data-card-label">Chlorine:</span>
                        <span>
                            {% if quality.chlorine_level %}
                                <span class="{% if quality.chlorine_level >= 1.0 and quality.chlorine_level <= 3.0 %}status-open{% else %}status-closed{% endif %}">
                                    {{ quality.chlorine_level }} ppm
                                </span>
                            {% else %}
                                <span style="color: var(--text-secondary);">N/A</span>
                            {% endif %}
                        </span>
                    </div>
                    <div class="data-card-actions">
                        <button class="btn-sm btn-primary" type="button"
                            onclick="openQualityViewModal(this)"
                            data-quality='{
                                "pool_name": "{{ quality.pool.name|escapejs }}",
                                "cleanliness_rating": "{{ quality.cleanliness_rating }}",
                                "pH_level": "{{ quality.pH_level|default_if_none:"" }}",
                                "water_temperature": "{{ quality.water_temperature|default_if_none:"" }}",
                                "chlorine_level": "{{ quality.chlorine_level|default_if_none:"" }}",
                                "date": "{{ quality.date|date:"M d, Y" }}"
                            }'
                        >View</button>
                        <button class="btn-sm btn-secondary"
                                onclick="openEditQualityModal(this)"
                                data-url="{% url 'edit_quality' quality.quality_id %}"
                                data-quality='{
                                    "pool_id": "{{ quality.pool.pool_id }}",
                                    "cleanliness_rating": "{{ quality.cleanliness_rating }}",
                                    "pH_level": "{{ quality.pH_level|default_if_none:"" }}",
                                    "water_temperature": "{{ quality.water_temperature|default_if_none:"" }}",
                                    "chlorine_level": "{{ quality.chlorine_level|default_if_none:"" }}",
                                    "date": "{{ quality.date|date:"Y-m-d" }}"
                                }'>
                            Edit
                        </button>
                        <button class="btn-sm btn-danger">
                            <a href="{% url 'delete_quality' quality.quality_id %}" style="text-decoration: none; color: white;"
                               onclick="return confirm('Are you sure you want to delete this quality record?');">Delete</a>
                        </button>
                    </div>
                </div>
                {% empty %}
                <p style="color: var(--text-secondary);">No quality records found. Add a new record to get started.</p>
                {% endfor %}
            </div>
        </div>

        <!-- Add/Edit Quality Modal -->
        <div id="qualityModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Add Quality Record</h2>
                    <span class="close" onclick="toggleModal('qualityModal')">&times;</span>
                </div>
                <form method="POST" id="qualityForm" action="{% url 'add_quality' %}">
                    {% csrf_token %}
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="quality_pool_id">Pool</label>
                            <select id="quality_pool_id" name="pool_id" required>
                                <option value="">Select Pool</option>
                                {% for pool in pools %}
                                <option value="{{ pool.pool_id }}">{{ pool.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quality_date">Date</label>
                            <input type="date" id="quality_date" name="date" required>
                        </div>
                        <div class="form-group">
                            <label for="cleanliness_rating">Cleanliness Rating (1-5)</label>
                            <select id="cleanliness_rating" name="cleanliness_rating" required>
                                <option value="">Select Rating</option>
                                <option value="1">1 - Poor</option>
                                <option value="2">2 - Fair</option>
                                <option value="3">3 - Good</option>
                                <option value="4">4 - Very Good</option>
                                <option value="5">5 - Excellent</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pH_level">pH Level</label>
                            <input type="number" id="pH_level" name="pH_level" step="0.01" min="0" max="14" placeholder="e.g., 7.4">
                        </div>
                        <div class="form-group">
                            <label for="water_temperature">Water Temperature (°C)</label>
                            <input type="number" id="water_temperature" name="water_temperature" step="0.1" placeholder="e.g., 27.5">
                        </div>
                        <div class="form-group">
                            <label for="chlorine_level">Chlorine Level (ppm)</label>
                            <input type="number" id="chlorine_level" name="chlorine_level" step="0.01" min="0" placeholder="e.g., 2.0">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" onclick="toggleModal('qualityModal')">Cancel</button>
                        <button type="submit" class="btn-primary">Save Record</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Quality Modal -->
        <div id="qualityViewModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Quality Details</h2>
                    <span class="close" onclick="toggleModal('qualityViewModal')">&times;</span>
                </div>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Pool</span>
                        <span class="detail-value" id="quality_view_pool"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date</span>
                        <span class="detail-value" id="quality_view_date"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Rating</span>
                        <span class="detail-value" id="quality_view_rating"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">pH</span>
                        <span class="detail-value" id="quality_view_ph"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Temp</span>
                        <span class="detail-value" id="quality_view_temp"></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Chlorine</span>
                        <span class="detail-value" id="quality_view_chlorine"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-secondary" onclick="toggleModal('qualityViewModal')">Close</button>
                </div>
            </div>
        </div>

    </main>
</div>
{% endblock %}
