{% extends 'base.html' %}
{% load static %}

{% block title %}Manage Classes - SwimSync EDU{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/admin_manage.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-layout">
    {% include "./components/admin_sidebar.html" %}

    <main class="dashboard-main">
        {% include "../../components/message.html" %}
        <div class="dashboard-header">
            <h1>Manage Class Sessions</h1>
            <button class="btn-primary" onclick="toggleModal('classModal')">Schedule New Class</button>
        </div>

        <form class="filter-bar" method="GET">
            <div class="filter-main">
                <div class="filter-search">
                    <input type="text" class="filter-input" name="q" placeholder="Search classes..." value="{{ request.GET.q|default_if_none:'' }}">
                    <button type="submit" class="btn-secondary">Search</button>
                    <button type="button" class="btn-secondary filter-toggle" aria-expanded="false" aria-controls="filters-classes">Filters v</button>
                </div>
            </div>
            <div class="filter-advanced" id="filters-classes">
                <div class="filter-field">
                    <label>Status</label>
                    <select class="filter-select" name="status">
                        <option value="">All</option>
                        <option value="open" {% if request.GET.status == 'open' %}selected{% endif %}>Open</option>
                        <option value="cancelled" {% if request.GET.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </div>
                <div class="filter-field">
                    <label>Pool</label>
                    <select class="filter-select" name="pool">
                        <option value="">All Pools</option>
                        {% for pool in pools %}
                        <option value="{{ pool.pool_id }}" {% if request.GET.pool == pool.pool_id|stringformat:"i" %}selected{% endif %}>{{ pool.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-field">
                    <label>Trainer</label>
                    <select class="filter-select" name="trainer">
                        <option value="">All Trainers</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.user_id }}" {% if request.GET.trainer == trainer.user_id|stringformat:"i" %}selected{% endif %}>{{ trainer.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-field">
                    <label>Start</label>
                    <input type="date" class="filter-date" name="start" value="{{ request.GET.start|default_if_none:'' }}">
                </div>
                <div class="filter-field">
                    <label>End</label>
                    <input type="date" class="filter-date" name="end" value="{{ request.GET.end|default_if_none:'' }}">
                </div>
            </div>
        </form>

        <!-- CARD GRID -->
        <div class="dashboard-section card-grid">
            {% for session in classes %}
            <div class="class-card">
                <span class="class-status {% if session.is_cancelled %}status-cancelled{% else %}status-open{% endif %}">
                    {% if session.is_cancelled %}Cancelled{% else %}Open{% endif %}
                </span>
                <h3>{{ session.class_name }}</h3>
                <p><strong>Pool:</strong> {{ session.pool.name }}</p>
                <p><strong>Trainer:</strong> {{ session.user.full_name|default:session.user.username }}</p>
                <p><strong>Dates:</strong> {{ session.start_date|date:"M d" }} - {{ session.end_date|date:"M d" }}</p>
                <p><strong>Total Price:</strong> ${{ session.total_price }}</p>

                <div class="card-actions">
                    <button type="button" class="btn-sm btn-primary"
                        onclick="openViewModal(this)"
                        data-class-name="{{ session.class_name|escape }}"
                        data-pool-name="{{ session.pool.name|escape }}"
                        data-trainer-name="{{ session.user.full_name|default:session.user.username|escape }}"
                        data-class-type="{{ session.class_type.class_type_id }}"
                        data-start-date="{{ session.start_date|date:"Y-m-d" }}"
                        data-end-date="{{ session.end_date|date:"Y-m-d" }}"
                        data-start-time="{{ session.start_time|time:"H:i" }}"
                        data-end-time="{{ session.end_time|time:"H:i" }}"
                        data-seats="{{ session.seats }}"
                        data-total-price="{{ session.total_price }}"
                        data-is-cancelled="{% if session.is_cancelled %}true{% else %}false{% endif %}">
                        View
                    </button>

                    <button type="button" class="btn-sm btn-secondary"
                        onclick="openEditClassModal(this)"
                        data-url="{% url 'edit_class' session.id %}"
                        data-class-name="{{ session.class_name|escape }}"
                        data-pool-id="{{ session.pool.pool_id }}"
                        data-class-type-id="{{ session.class_type.class_type_id }}"
                        data-user-id="{{ session.user.user_id }}"
                        data-start-date="{{ session.start_date|date:"Y-m-d" }}"
                        data-end-date="{{ session.end_date|date:"Y-m-d" }}"
                        data-start-time="{{ session.start_time|time:"H:i" }}"
                        data-end-time="{{ session.end_time|time:"H:i" }}"
                        data-seats="{{ session.seats }}"
                        data-is-cancelled="{% if session.is_cancelled %}true{% else %}false{% endif %}">
                        Edit
                    </button>

                    <button class="btn-sm btn-danger">
                        <a href="{% url 'close_class_session' session.id %}" style="color:white;text-decoration:none;"
                        onclick="return confirm('Are you sure you want to cancel this class session?');">
                        Cancel
                        </a>
                    </button>
                </div>
            </div>
            {% empty %}
                <p>No class sessions scheduled. Click "Schedule New Class" to get started.</p>
            {% endfor %}
        </div>
    </main>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2 id="view_class_name">Class Name</h2>
            <span class="close" onclick="toggleModal('viewModal')">&times;</span>
        </div>
        <div class="details-grid">
            <div class="detail-item">
                <span class="detail-label">Pool</span>
                <span class="detail-value" id="view_pool"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Trainer</span>
                <span class="detail-value" id="view_trainer"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Class Type</span>
                <span class="detail-value" id="view_type"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Dates</span>
                <span class="detail-value" id="view_dates"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Time</span>
                <span class="detail-value" id="view_time"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Seats</span>
                <span class="detail-value" id="view_seats"></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Total Price</span>
                <span class="detail-value">$<span id="view_price"></span></span>
            </div>
            <div class="detail-item">
                <span class="detail-label">Cancelled</span>
                <span class="detail-value" id="view_cancelled"></span>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-secondary" onclick="toggleModal('viewModal')">Close</button>
        </div>
    </div>
</div>
<!-- CLASS MODAL -->
<div id="classModal" class="modal">
    <div class="modal-content modal-lg">
        <div class="modal-header">
            <h2>Schedule New Class Session</h2>
            <span class="close" onclick="toggleModal('classModal')">&times;</span>
        </div>
        <form method="POST">
            {% csrf_token %}
            <div class="form-grid">
                <div class="form-group">
                    <label for="class_name">Class Name</label>
                    <input type="text" id="class_name" name="class_name" required>
                </div>
                <div class="form-group">
                    <label for="pool_id">Select Pool</label>
                    <select id="pool_id" name="pool_id" required>
                        <option value="">Choose a pool...</option>
                        {% for pool in pools %}
                        <option value="{{ pool.pool_id }}">{{ pool.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="class_type_id">Class Type</label>
                    <select id="class_type_id" name="class_type_id" required>
                        <option value="">Choose type...</option>
                        {% for type in class_types %}
                        <option value="{{ type.class_type_id }}" data-duration="{{ type.duration_days }}">{{ type.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="user_id">Assign Trainer</label>
                    <select id="user_id" name="user_id" required>
                        <option value="">Choose trainer...</option>
                        {% for trainer in trainers %}
                        <option value="{{ trainer.user_id }}">{{ trainer.full_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="start_date">Start Date</label>
                    <input type="date" id="start_date" name="start_date" required>
                </div>
                <div class="form-group">
                    <label for="end_date">End Date</label>
                    <input type="date" id="end_date" name="end_date" readonly>
                </div>
                <div class="form-group">
                    <label for="start_time">Start Time</label>
                    <input type="time" id="start_time" name="start_time" required>
                </div>
                <div class="form-group">
                    <label for="end_time">End Time</label>
                    <input type="time" id="end_time" name="end_time" required>
                </div>
                <div class="form-group">
                    <label for="seats">Available Seats</label>
                    <input type="number" id="seats" name="seats" required>
                </div>
                <div class="form-group checkbox-group" id="cancelled_group" style="display: none;">
                    <label class="checkbox-label" for="is_cancelled">
                        <input type="checkbox" id="is_cancelled" name="is_cancelled">
                        Cancelled
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="toggleModal('classModal')">Cancel</button>
                <button type="submit" class="btn-primary">Schedule Class</button>
            </div>
        </form>
    </div>
</div>

<!-- JS to auto-fill end date -->
<script>
const classTypeSelect = document.getElementById('class_type_id');
const startDateInput = document.getElementById('start_date');
const endDateInput = document.getElementById('end_date');

function updateEndDate() {
    const selectedOption = classTypeSelect.options[classTypeSelect.selectedIndex];
    const duration = parseInt(selectedOption.dataset.duration || 0, 10);
    const startDateValue = startDateInput.value;

    if (startDateValue && duration > 0) {
        const startDate = new Date(startDateValue);
        startDate.setDate(startDate.getDate() + duration - 1); // duration includes start day
        const yyyy = startDate.getFullYear();
        const mm = String(startDate.getMonth() + 1).padStart(2, '0');
        const dd = String(startDate.getDate()).padStart(2, '0');
        endDateInput.value = `${yyyy}-${mm}-${dd}`;
    } else {
        endDateInput.value = '';
    }
}

startDateInput.addEventListener('change', updateEndDate);
classTypeSelect.addEventListener('change', updateEndDate);
</script>
{% endblock %}